From 65c5a1792286071619d7f5759b902d62d8099b1c Mon Sep 17 00:00:00 2001
From: Philip Tricca <flihp@twobit.us>
Date: Sun, 11 Dec 2016 15:48:58 -0800
Subject: [PATCH] Add support for the tabrmd TCTI module.

Signed-off-by: Lans Zhang <jia.zhang@windriver.com>
---
 Makefile.am        |  4 ++--
 configure.ac       | 22 +++++++++++++++++++++-
 lib/context-util.c | 38 ++++++++++++++++++++++++++++++++++++++
 lib/options.c      | 20 ++++++++++++++++++++
 lib/options.h      | 12 +++++++++---
 5 files changed, 90 insertions(+), 6 deletions(-)

diff --git a/Makefile.am b/Makefile.am
index 54a1347..a3c43f8 100644
--- a/Makefile.am
+++ b/Makefile.am
@@ -35,10 +35,10 @@ ACLOCAL_AMFLAGS = -I m4
 INCLUDE_DIRS = -I$(srcdir)/src -I$(srcdir)/lib
 LIB_COMMON := lib/libcommon.a
 
-AM_CFLAGS    := $(INCLUDE_DIRS) $(TPM20_TSS_CFLAGS) $(EXTRA_CFLAGS)
+AM_CFLAGS    := $(INCLUDE_DIRS) $(TPM20_TSS_CFLAGS) $(EXTRA_CFLAGS) $(TCTI_TABRMD_CFLAGS)
 AM_LDFLAGS   := $(EXTRA_LDFLAGS)
 
-LDADD = $(LIB_COMMON) $(TPM20_TSS_LIBS) $(TCTI_SOCK_LIBS) $(TCTI_DEV_LIBS)
+LDADD = $(LIB_COMMON) $(TPM20_TSS_LIBS) $(TCTI_SOCK_LIBS) $(TCTI_DEV_LIBS) $(TCTI_TABRMD_LIBS)
 
 sbin_PROGRAMS = \
     tools/tpm2_create \
diff --git a/configure.ac b/configure.ac
index af6f144..c4f0da4 100644
--- a/configure.ac
+++ b/configure.ac
@@ -43,9 +43,29 @@ AS_IF(
              AC_MSG_FAILURE([--with-tcti-socket option provided but libtcti-socket not detected.])
          fi])])
 AM_CONDITIONAL([HAVE_TCTI_SOCK],[test "x$with_tcti_socket" = "xyes"])
+# disable libtcti-tabrmd selectively (enabled by default)
+AC_ARG_WITH(
+    [tcti-tabrmd],
+    [AS_HELP_STRING([--with-tcti-tabrmd],
+        [Build tools with support for the tabrmd TCTI.])],
+    [],
+    [with_tcti_tabrmd=check])
+AS_IF(
+    [test "x$with_tcti_tabrmd" != "xno"],
+    [PKG_CHECK_MODULES(
+        [TCTI_TABRMD],
+        [tcti-tabrmd],
+        [AC_DEFINE([HAVE_TCTI_TABRMD], [1])
+         with_tcti_tabrmd=yes],
+        [if test "x$with_tcti_tabrmd" = "xyes"; then
+             AC_MSG_FAILURE([--with-tcti-tabrmd option provided but libtcti-tabrmd not detected.])
+         fi])])
+AM_CONDITIONAL([HAVE_TCTI_TABRMD],[test "x$with_tcti_tabrmd" = "xyes"])
 # ensure we have at least one TCTI enabled, can't do much without one
 AS_IF(
-    [test "x$with_tcti_device" != "xyes" -a "x$with_tcti_socket" != "xyes"],
+    [test "x$with_tcti_device" != "xyes" -a \
+          "x$with_tcti_socket" != "xyes" -a \
+          "x$with_tcti_tabrmd" != "xyes"],
     [AC_MSG_ERROR(
         [no TCTIs: at least one TCTI library must be enabled],
         [1])])
diff --git a/lib/context-util.c b/lib/context-util.c
index 7b9a454..88a24b1 100644
--- a/lib/context-util.c
+++ b/lib/context-util.c
@@ -36,6 +36,9 @@
 #ifdef HAVE_TCTI_SOCK
 #include <tcti/tcti_socket.h>
 #endif
+#ifdef HAVE_TCTI_TABRMD
+#include <tcti/tcti-tabrmd.h>
+#endif
 
 #include "context-util.h"
 
@@ -124,6 +127,37 @@ tcti_socket_init (char const *address,
     return tcti_ctx;
 }
 #endif
+#ifdef HAVE_TCTI_TABRMD
+TSS2_TCTI_CONTEXT*
+tcti_tabrmd_init (void)
+{
+    TSS2_TCTI_CONTEXT *tcti_ctx;
+    TSS2_RC rc;
+    size_t size;
+
+    rc = tss2_tcti_tabrmd_init(NULL, &size);
+    if (rc != TSS2_RC_SUCCESS) {
+        fprintf (stderr,
+                 "Failed to get size for TABRMD TCTI context: 0x%x\n",
+                 rc);
+        return NULL;
+    }
+    tcti_ctx = (TSS2_TCTI_CONTEXT*)calloc (1, size);
+    if (tcti_ctx == NULL) {
+        fprintf (stderr, "Allocation for TABRMD TCTI context failed: %s\n",
+                 strerror (errno));
+        return NULL;
+    }
+    rc = tss2_tcti_tabrmd_init (tcti_ctx, &size);
+    if (rc != TSS2_RC_SUCCESS) {
+        fprintf (stderr, "Failed to initialize TABRMD TCTI context: 0x%x\n",
+                 rc);
+        free (tcti_ctx);
+        return NULL;
+    }
+    return tcti_ctx;
+}
+#endif
 /*
  * Initialize a SAPI context using the TCTI context provided by the caller.
  * This function allocates memory for the SAPI context and returns it to the
@@ -194,6 +228,10 @@ tcti_init_from_options (common_opts_t *options)
         return tcti_socket_init (options->socket_address,
                                  options->socket_port);
 #endif
+#ifdef HAVE_TCTI_TABRMD
+    case TABRMD_TCTI:
+        return tcti_tabrmd_init ();
+#endif
     default:
         return NULL;
     }
diff --git a/lib/options.c b/lib/options.c
index f09c5fa..44df3f8 100644
--- a/lib/options.c
+++ b/lib/options.c
@@ -67,6 +67,12 @@ tcti_map_entry_t tcti_map_table[] = {
         .type = SOCKET_TCTI,
     },
 #endif
+#ifdef HAVE_TCTI_TABRMD
+    {
+        .name = "tabrmd",
+        .type = TABRMD_TCTI,
+    },
+#endif
     {
         .name = "unknown",
         .type = UNKNOWN_TCTI,
@@ -136,6 +142,11 @@ sanity_check_common (common_opts_t  *opts)
         }
         break;
 #endif
+#ifdef HAVE_TCTI_TABRMD
+    case TABRMD_TCTI:
+        /* no options for this one yet */
+        break;
+#endif
     default:
         fprintf (stderr, "invalid TCTI, see --help\n");
         return 2;
@@ -244,6 +255,9 @@ get_common_opts (int                    *argc_param,
             .val     = 'p',
         },
 #endif
+#ifdef HAVE_TCTI_TABRMD
+        /* no options for this TCTI yet */
+#endif
         {
             .name    = "help",
             .has_arg = no_argument,
@@ -322,6 +336,9 @@ get_common_opts (int                    *argc_param,
             }
         }   break;
 #endif
+#ifdef HAVE_TCTI_TABRMD
+        /* No options for this TCTI yet. */
+#endif
         case 'h':
             common_opts->help = true;
             break;
@@ -363,6 +380,9 @@ dump_common_opts (common_opts_t *opts)
     printf ("  address:          %s\n", opts->socket_address);
     printf ("  port:             %d\n", opts->socket_port);
 #endif
+#ifdef HAVE_TCTI_TABRMD
+    /* No options for this TCTI yet. */
+#endif
     printf ("  help:             %s\n", opts->help    ? "true" : "false");
     printf ("  verbose:          %s\n", opts->verbose ? "true" : "false");
     printf ("  version:          %s\n", opts->version ? "true" : "false");
diff --git a/lib/options.h b/lib/options.h
index e968bd0..73af208 100644
--- a/lib/options.h
+++ b/lib/options.h
@@ -44,12 +44,15 @@
  * We do this to preserve the current default / expected behavior (use of
  * the socket TCTI).
  */
-#ifdef HAVE_TCTI_SOCK
-  #define TCTI_DEFAULT      SOCKET_TCTI
-  #define TCTI_DEFAULT_STR  "socket"
+#ifdef HAVE_TCTI_TABRMD
+  #define TCTI_DEFAULT      TABRMD_TCTI
+  #define TCTI_DEFAULT_STR  "tabrmd"
 #elif  HAVE_TCTI_DEV
   #define TCTI_DEFAULT      DEVICE_TCTI
   #define TCTI_DEFAULT_STR  "device"
+#elif HAVE_TCTI_SOCK
+  #define TCTI_DEFAULT      SOCKET_TCTI
+  #define TCTI_DEFAULT_STR  "socket"
 #endif
 
 /* Defaults for Device TCTI */
@@ -82,6 +85,9 @@ typedef enum {
 #ifdef HAVE_TCTI_SOCK
     SOCKET_TCTI,
 #endif
+#ifdef HAVE_TCTI_TABRMD
+    TABRMD_TCTI,
+#endif
     UNKNOWN_TCTI,
     N_TCTI,
 } TCTI_TYPE;
-- 
2.11.0

